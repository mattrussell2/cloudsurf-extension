//SVG logo as a string, so it can be used as the innerhtml of a div
var cloudWithEmoji =  '<svg id="buttonSVG" viewBox="0 0 242 242" fill="none" xmlns="http://www.w3.org/2000/svg"> <g id="SmileySurfer"> <g id="Outline"> <g id="Rectangle 7"> <rect width="242" height="241" rx="56" fill="white"/> <rect width="242" height="241" rx="56" fill="url(#paint0_linear)"/> </g> </g> <g id="Cloud"> <path id="Vector" d="M206.594 105.932H206.575C206.575 105.806 206.594 105.679 206.594 105.552C206.594 88.2425 192.081 74.1956 174.156 74.1956C171.85 74.1956 169.6 74.4312 167.444 74.8844C161.013 59.7681 145.656 49.1106 127.694 49.1106C114.213 49.1106 102.194 55.1281 94.3188 64.5169C89.0907 61.9468 83.3091 60.6054 77.4438 60.6019C58.0375 60.6019 42.1001 74.8844 40.2438 93.1725C19.1501 94.26 2.2188 110.971 1.93755 131.724C1.63755 153.329 19.5438 171.092 41.8938 171.364C43.6376 171.382 45.3251 171.273 47.0126 171.074C55.6563 188.691 74.2 200.871 95.7063 200.871C108.681 200.871 120.569 196.431 129.869 189.054C136.975 194.147 145.75 197.192 155.275 197.192C174.813 197.192 191.256 184.522 196.375 167.213C199.6 168.246 203.031 168.826 206.613 168.826C224.575 168.826 239.144 154.743 239.144 137.379C239.125 120.016 224.575 105.932 206.594 105.932Z" fill="white"/> </g> <g id="Smile"> <g id="Smile_2"> <rect width="79" height="79" transform="translate(83 81)" fill="white"/> <g id="Vector_2"> <path d="M122.5 87.5833C104.35 87.5833 89.5833 102.35 89.5833 120.5C89.5833 138.65 104.35 153.417 122.5 153.417C140.65 153.417 155.417 138.65 155.417 120.5C155.417 102.35 140.65 87.5833 122.5 87.5833ZM122.5 146.833C107.98 146.833 96.1666 135.02 96.1666 120.5C96.1666 105.98 107.98 94.1667 122.5 94.1667C137.019 94.1667 148.833 105.98 148.833 120.5C148.833 135.02 137.019 146.833 122.5 146.833Z" fill="black"/> <path d="M122.5 87.5833C104.35 87.5833 89.5833 102.35 89.5833 120.5C89.5833 138.65 104.35 153.417 122.5 153.417C140.65 153.417 155.417 138.65 155.417 120.5C155.417 102.35 140.65 87.5833 122.5 87.5833ZM122.5 146.833C107.98 146.833 96.1666 135.02 96.1666 120.5C96.1666 105.98 107.98 94.1667 122.5 94.1667C137.019 94.1667 148.833 105.98 148.833 120.5C148.833 135.02 137.019 146.833 122.5 146.833Z" fill="url(#paint1_linear)"/> </g> <g id="Vector_3"> <path d="M131.812 129.809C130.609 131.008 129.188 131.967 127.625 132.633C124.812 133.821 121.673 133.994 118.746 133.124C115.819 132.253 113.285 130.392 111.578 127.86L106.121 131.544C107.544 133.644 109.355 135.454 111.456 136.876C113.595 138.322 115.998 139.332 118.527 139.848C121.15 140.383 123.853 140.383 126.476 139.848C129.005 139.331 131.408 138.321 133.547 136.876C134.577 136.178 135.561 135.368 136.463 134.47C137.359 133.578 138.175 132.59 138.879 131.544L133.422 127.86C132.949 128.56 132.41 129.212 131.812 129.809Z" fill="black"/> <path d="M131.812 129.809C130.609 131.008 129.188 131.967 127.625 132.633C124.812 133.821 121.673 133.994 118.746 133.124C115.819 132.253 113.285 130.392 111.578 127.86L106.121 131.544C107.544 133.644 109.355 135.454 111.456 136.876C113.595 138.322 115.998 139.332 118.527 139.848C121.15 140.383 123.853 140.383 126.476 139.848C129.005 139.331 131.408 138.321 133.547 136.876C134.577 136.178 135.561 135.368 136.463 134.47C137.359 133.578 138.175 132.59 138.879 131.544L133.422 127.86C132.949 128.56 132.41 129.212 131.812 129.809Z" fill="url(#paint2_linear)"/> </g> <g id="Vector_4"> <path d="M110.979 120.5C113.706 120.5 115.917 118.289 115.917 115.562C115.917 112.836 113.706 110.625 110.979 110.625C108.252 110.625 106.042 112.836 106.042 115.562C106.042 118.289 108.252 120.5 110.979 120.5Z" fill="black"/> <path d="M110.979 120.5C113.706 120.5 115.917 118.289 115.917 115.562C115.917 112.836 113.706 110.625 110.979 110.625C108.252 110.625 106.042 112.836 106.042 115.562C106.042 118.289 108.252 120.5 110.979 120.5Z" fill="url(#paint3_linear)"/> </g> <g id="Vector_5"> <path d="M133.998 120.454C136.712 120.454 138.912 118.254 138.912 115.539C138.912 112.825 136.712 110.625 133.998 110.625C131.284 110.625 129.083 112.825 129.083 115.539C129.083 118.254 131.284 120.454 133.998 120.454Z" fill="black"/> <path d="M133.998 120.454C136.712 120.454 138.912 118.254 138.912 115.539C138.912 112.825 136.712 110.625 133.998 110.625C131.284 110.625 129.083 112.825 129.083 115.539C129.083 118.254 131.284 120.454 133.998 120.454Z" fill="url(#paint4_linear)"/> </g> </g> </g> <g id="Cloud-Shadow"> <path id="Vector_6" d="M225.719 111.932C233.087 119.128 227.875 135.621 222.812 141.004C212.838 151.571 194.538 149.106 187.188 147.584C185.2 147.167 184.881 147.312 184.225 147.693C183.644 148.037 183.381 148.581 182.744 149.868C180.381 154.798 174.269 164.349 161.369 168.192C147.925 172.198 135.25 166.089 129.325 162.446C127.075 161.069 126.981 161.033 125.969 161.051C124.938 161.069 123.925 161.794 122.706 162.718C117.344 166.796 105.1 173.992 86.2188 172.941C67.7125 171.907 57.1188 160.888 53.4813 155.214C52.7875 154.127 52.0375 153.221 51.175 153.13C50.1813 153.039 49.075 154.018 48.25 154.816C40.375 162.229 15.5875 164.458 7.375 151.825C15.7375 164.784 28.6562 171.201 41.9125 171.364C43.6562 171.382 45.3438 171.273 47.0312 171.074C55.675 188.691 74.2188 200.871 95.725 200.871C108.7 200.871 120.587 196.431 129.887 189.054C136.994 194.147 145.769 197.192 155.294 197.192C174.831 197.192 191.275 184.523 196.394 167.213C199.619 168.246 203.05 168.826 206.631 168.826C224.594 168.826 239.162 154.743 239.162 137.379C239.125 128.136 234.325 117.696 225.719 111.932Z" fill="#7E98A8"/> </g> </g> <defs> <linearGradient id="paint0_linear" x1="121" y1="0" x2="121" y2="241" gradientUnits="userSpaceOnUse"> <stop offset="0.0913884" stop-color="#B7094C"/> <stop offset="0.317708" stop-color="#892B64"/> <stop offset="0.541667" stop-color="#5C4D7D"/> <stop offset="1" stop-color="#2E6F95"/> </linearGradient> <linearGradient id="paint1_linear" x1="122.5" y1="87.5833" x2="122.5" y2="153.417" gradientUnits="userSpaceOnUse"> <stop offset="0.0913884" stop-color="#B7094C"/> <stop offset="0.317708" stop-color="#892B64"/> <stop offset="0.541667" stop-color="#5C4D7D"/> <stop offset="1" stop-color="#2E6F95"/> </linearGradient> <linearGradient id="paint2_linear" x1="122.5" y1="127.86" x2="122.5" y2="140.25" gradientUnits="userSpaceOnUse"> <stop stop-color="#892B64"/> <stop offset="0.421875" stop-color="#5C4D7D"/> <stop offset="1" stop-color="#2E6F95"/> </linearGradient> <linearGradient id="paint3_linear" x1="110.979" y1="110.625" x2="110.979" y2="120.5" gradientUnits="userSpaceOnUse"> <stop offset="0.0913884" stop-color="#B7094C"/> <stop offset="0.546875" stop-color="#892B64"/> <stop offset="0.90625" stop-color="#5C4D7D"/> </linearGradient> <linearGradient id="paint4_linear" x1="133.998" y1="110.625" x2="133.998" y2="120.454" gradientUnits="userSpaceOnUse"> <stop offset="0.223958" stop-color="#B7094C"/> <stop offset="0.583333" stop-color="#892B64"/> <stop offset="0.770833" stop-color="#5C4D7D"/> <stop offset="1" stop-color="#2E6F95"/> </linearGradient> </defs> </svg>'
var cloudNoEmoji   =  '<svg id="buttonSVG" viewBox="0 0 242 241" fill="none" xmlns="http://www.w3.org/2000/svg"> <g id="Cloudsurf Icon"> <g id="Cloud-Background"> <g id="Rectangle 7"> <rect width="242" height="241" rx="56" fill="white"/> <rect width="242" height="241" rx="56" fill="url(#paint0_linear)"/> </g> </g> <g id="Cloud"> <path id="Vector" d="M206.594 105.932H206.575C206.575 105.806 206.594 105.679 206.594 105.552C206.594 88.2425 192.081 74.1956 174.156 74.1956C171.85 74.1956 169.6 74.4312 167.444 74.8844C161.013 59.7681 145.656 49.1106 127.694 49.1106C114.213 49.1106 102.194 55.1281 94.3188 64.5169C89.0907 61.9468 83.3091 60.6054 77.4438 60.6019C58.0375 60.6019 42.1001 74.8844 40.2438 93.1725C19.1501 94.26 2.2188 110.971 1.93755 131.724C1.63755 153.329 19.5438 171.092 41.8938 171.364C43.6376 171.382 45.3251 171.273 47.0126 171.074C55.6563 188.691 74.2 200.871 95.7063 200.871C108.681 200.871 120.569 196.431 129.869 189.054C136.975 194.147 145.75 197.192 155.275 197.192C174.813 197.192 191.256 184.522 196.375 167.213C199.6 168.246 203.031 168.826 206.613 168.826C224.575 168.826 239.144 154.743 239.144 137.379C239.125 120.016 224.575 105.932 206.594 105.932Z" fill="white"/> </g> <g id="Cloud-Shadow"> <path id="Vector_2" d="M225.719 111.932C233.087 119.128 227.875 135.621 222.812 141.004C212.838 151.571 194.538 149.106 187.188 147.584C185.2 147.167 184.881 147.312 184.225 147.693C183.644 148.037 183.381 148.581 182.744 149.868C180.381 154.798 174.269 164.349 161.369 168.192C147.925 172.198 135.25 166.089 129.325 162.446C127.075 161.069 126.981 161.033 125.969 161.051C124.938 161.069 123.925 161.794 122.706 162.718C117.344 166.796 105.1 173.992 86.2188 172.941C67.7125 171.907 57.1188 160.888 53.4813 155.214C52.7875 154.127 52.0375 153.221 51.175 153.13C50.1813 153.039 49.075 154.018 48.25 154.816C40.375 162.229 15.5875 164.458 7.375 151.825C15.7375 164.784 28.6562 171.201 41.9125 171.364C43.6562 171.382 45.3438 171.273 47.0312 171.074C55.675 188.691 74.2188 200.871 95.725 200.871C108.7 200.871 120.587 196.431 129.887 189.054C136.994 194.147 145.769 197.192 155.294 197.192C174.831 197.192 191.275 184.523 196.394 167.213C199.619 168.246 203.05 168.826 206.631 168.826C224.594 168.826 239.162 154.743 239.162 137.379C239.125 128.136 234.325 117.696 225.719 111.932Z" fill="#7E98A8"/> </g> </g> <defs> <linearGradient id="paint0_linear" x1="121" y1="0" x2="121" y2="241" gradientUnits="userSpaceOnUse"> <stop offset="0.0913884" stop-color="#B7094C"/> <stop offset="0.317708" stop-color="#892B64"/> <stop offset="0.541667" stop-color="#5C4D7D"/> <stop offset="1" stop-color="#2E6F95"/> </linearGradient> </defs> </svg> '


var clickCheck = function(e) {
    e = e || window.event;
    var target = e.target; 
    var count = 0;
    console.log("target id: " ,target.getAttribute("id"));
    while (target.getAttribute("id") != "reactContainer" &&  target.getAttribute("id") != "reactButton" && target.parentElement != null) {
        console.log(target.getAttribute("id"));
        target = target.parentElement;
    }
    if(target.getAttribute("id") == "reactContainer"){
           console.log("Detected click in react container!!!!!!");
    }
    else if( target.getAttribute("id") == "reactButton" ) {
        console.log("Don't worry about this one.");
    }
    else{
        closeReacts("no-select")
    }
}


function listenForClose(){
    document.addEventListener('click', clickCheck, false);
}
function stopListening(){
    document.removeEventListener('click', clickCheck);
}


//Listener for content script url change message, need to refresh emotion get
chrome.runtime.onMessage.addListener(
    function(request, sender, sendResponse) {
    //   console.log(sender.tab ?
    //               "from a content script:" + sender.tab.url :
    //               "from the extension");
      if (request.url)
        //get new emotion information
        console.log(request.url)
        sendResponse({farewell: "goodbye"});
    }
  );

// getting user identifiers and settings
var email, userid, rows, cols, size;
chrome.storage.sync.get(['email', 'id','rows','cols','size'], function(result) {	
    email  = result.email;
    userid = result.id;
    rows   = result.rows;
    cols   = result.cols;
    size   = result.size;
    //just actually calling drawScreen
    drawScreen("left", size, 1, 1, emotions, rows, cols);
});


//unicodes corresponding to emoticons
var emotions = [ 
                 "128544",  //angry
                 "128546",  //crying
                 "128552",  //afraid
                 "128562",  //astonished
                 "128578",  //smiling
                 "128525",  //love
                 "128514",  //laugh
                 "128526",  //chill
                 "129320",  //oh?
                ];

// get unicodes ready for display in html
function htmlify(reactType){
    return "&#" + reactType + ";"
}


// function: drawScreen
// purpose:  instantiates all of the html necessary for the emotion tool
// arguments:
//          align : "left" or "right" - a user preference that allows users
//                  to describe the direction that the react container
//                  should open in
//          size  : integers that describes the scaling of the original button
//                  (in rems) -> the reacts themselves will be scaled
//                  proportionally
//           x,y  : integers - a user preference that describes how far to
//                  the right (x) and how far down up from the bottom (y) 
//                  their emotion tool appears on each page
//      emoticons : an array of emotion unicode strings corresponding to
//                  emotions that will be rendered on button click
//      rows, cols: integers - user preference that describes the numebr of
//                  rows and columns that their array of emotions has
function drawScreen(align, size, x, y, emoticons, rows, cols)
{
    reactButton   = makeReactButton(size, x, y);
    reactContain  = makeReacts(align, size, x, y, emoticons, rows, cols)
    selectedReact = makeSelectedReact(size); 

    reactButton.append(selectedReact);
    document.body.append(reactContain);
    document.body.append(reactButton);
}

// function makeReactButton
// purpose: make the div and set the basic attributes of the react
//          button
// arguments: 
//          size: integer (in rem) gets assigned to width and height
//          x,y : integers (in % of screen) get assigned to left
//                  and bottom, respectively
// returns:
//          the DOM div element itself
function makeReactButton(size, x, y)
{
    //generate the react button
    var reactButton = document.createElement( 'div' );
    reactButton.setAttribute("id", "reactButton");
    reactButton.onclick      = openReacts;
    
    //set user-specified attributers
    console.log("Size right here is "+size);
    reactButton.style.width  = size + "rem";
    reactButton.style.height = size + "rem";
    reactButton.style.left   = x + "%";
    reactButton.style.bottom = y + "%";
    
    //add wrapper that holds the svg logo itself
    var logoWrapper = document.createElement( 'div' );
    logoWrapper.setAttribute('id',"logoWrapper");
    logoWrapper.innerHTML    = cloudWithEmoji;
    reactButton.append(logoWrapper);

    return reactButton;
}

// function makeReacts
// purpose: 
//          make the react container and the reacts held within it,
//          as well as any other buttons or functionality for the
//          container.
// arguments:
//          align : "left" or "right" - a user preference that allows users
//                  to describe the direction that the react container
//                  should open in
//          size  : integers that describes the scaling of the original button
//                  (in rems) -> the reacts themselves will be scaled
//                  proportionally
//           x,y  : integers - a user preference that describes how far to
//                  the right (x) and how far down up from the bottom (y) 
//                  their emotion tool appears on each page
//      emoticons : an array of emotion unicode strings corresponding to
//                  emotions that will be rendered on button click
//      rows, cols: integers - user preference that describes the numebr of
//                  rows and columns that their array of emotions has
function makeReacts(align, size, x, y, emoticons, rows, cols)
{
    // make container to hold reactions
    var reactContainer = document.createElement( 'div' );
    reactContainer.setAttribute("id", "reactContainer");
    reactContainer.style.bottom = x+"%";
    reactContainer.style.left   = y+"%";

    reactContainer.style.setProperty('--grid-rows', rows);
    reactContainer.style.setProperty('--grid-cols', cols);

    for (emote in emoticons) {
        let react = document.createElement("div");
        react.innerHTML = htmlify(emoticons[emote])
        react.setAttribute("id", emoticons[emote]);
        react.style.fontSize = (size / 3) + "rem";
        react.onclick = function(e){ handleReact(e.target.getAttribute("id")); };
        reactContainer.appendChild(react).className = "grid-item reactText"
    }
    return reactContainer;
}

// makeSelectedReact
// purpose: create the div that will hold the selected reaction
// arguments:
//          size  : integers that describes the scaling of the original button
//                  (in rems) -> the reacts themselves will be scaled
//                  proportionally
//           x,y  : integers - a user preference that describes how far to
//                  the right (x) and how far down up from the bottom (y) 
//                  their emotion tool appears on each page
function makeSelectedReact(size)
{
    selectedReact = document.createElement("div");
    selectedReact.setAttribute("id","selectedReact");

    //dynamically set react and text size
    selectedReact.style.fontSize = ((3/10)*size)+'rem';
    selectedReact.style.height   = ((3/5) *size)+'rem';
    selectedReact.style.width    = ((3/5) *size)+'rem';

    return selectedReact;
}


// FUNCTIONALITY BEYOND INITIAL RENDER

// openReacts
// purpose: allow user to react to the page, TODO should set an onclick
//          to close for the rest of the body
function openReacts()
{
    console.log("Tried to open!")
    listenForClose();
    document.getElementById("reactButton").style.display    = "none";
    document.getElementById("reactContainer").style.display = "grid";
}




//handle the reaction made by the user
function handleReact(reactType) 
{
    // update the value of the react button
   // document.getElementById('reactButton').style.reactType = reactType  

    var data = {
        emotion: reactType,
        url:     window.location.href,
        userid:  userid
    };
    console.log("data: ", data)
    var req = new XMLHttpRequest();
    req.open("POST","https://the-prism.herokuapp.com/react", true);
    req.setRequestHeader("Content-type","application/json");
    req.onload = function (e) {
        if (req.readystate === 4) {
            if (req.status === 200) {
                console.log(req.responseText)
            }
            else{
                console.error(req.statusText)
            }
        }
    }
    req.onerror = function (e) {
        console.error(req.statusText)
    };
    req.send(JSON.stringify(data))
    closeReacts(reactType)
}

// setSelectedReact
// purpose: update the DOM with a selected reaction -> may be called on initial render if user has already
//          reacted to a page, and will be called whenever a user actually reacts or changes reaction
//
// arguments: 
//          reactType: unicode for the selected reaction
// returns:
//          nothing
function setSelectedReact(reactType) 
{
    document.getElementById("selectedReact").innerHTML = htmlify(reactType);
}  


// close the set of reactions
// replace smaller button with selected reaction, if applicable
function closeReacts(reactType) {
    
    console.log("Tried to close reactions.")
    stopListening();
    if (reactType != "no-select") {
        console.log("We think it's an actual reaction.")
        setSelectedReact(reactType);
        //TODO this isn't a good long term solution, we need a wrapper div just for the svg
        document.getElementById("logoWrapper").innerHTML = cloudNoEmoji;
    }
    
    // hide the react container
    document.getElementById("reactContainer").style.display = "none";
    
    //show the react button with the new background
    document.getElementById("reactButton").style.display = "flex";

}
